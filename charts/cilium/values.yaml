cilium:
  enabled: true

  # Configure logging for the Cilium Agent.
  extraArgs:
    - "--log-opt=format=json-ts"
    - "--log-opt=level=warn"

  # Allow running Cilium on a single node cluster.
  operator:
    replicas: 1
    extraArgs:
      - "--log-opt=format=json-ts"
      - "--log-opt=level=warn"

  # Tune Cilium for deployment on Talos.
  # Docs: https://www.talos.dev/v1.9/kubernetes-guides/network/deploying-cilium/#without-kube-proxy
  k8sServiceHost: localhost
  k8sServicePort: 7445

  ipam:
    mode: kubernetes

  kubeProxyReplacement: true

  # Fix hairpin NAT to ensure that the
  # cert-manager propagation check works.
  # Reference: https://github.com/cilium/cilium/issues/28254#issuecomment-2102374304
  bpf:
    masquerade: true

  securityContext:
    capabilities:
      ciliumAgent:
        - CHOWN
        - KILL
        - NET_ADMIN
        - NET_RAW
        - NET_BIND_SERVICE
        - IPC_LOCK
        - SYS_ADMIN
        - SYS_RESOURCE
        - DAC_OVERRIDE
        - FOWNER
        - SETGID
        - SETUID
      cleanCiliumState:
        - NET_ADMIN
        - SYS_ADMIN
        - SYS_RESOURCE

  cgroup:
    autoMount:
      enabled: false
    hostRoot: /sys/fs/cgroup

  # Create a replacement for klipper-lb.
  # Docs: https://docs.cilium.io/en/latest/network/node-ipam/
  nodeIPAM:
    enabled: true

  # Enable cilium support for the Gateway API.
  # Docs: https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#gs-gateway-api
  gatewayAPI:
    enabled: true

  # Ensure that we can create gateways for 80 and 443.
  # Docs: https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#bind-to-privileged-port
  envoy:
    enabled: true
    securityContext:
      capabilities:
        keepCapNetBindService: true
        envoy:
          - NET_BIND_SERVICE
          - NET_ADMIN
          - PERFMON
          - BPF

  # Enable hubble for network observability.
  # Docs: https://docs.cilium.io/en/latest/observability/hubble/hubble-ui/index.html
  hubble:
    relay:
      enabled: true
    ui:
      enabled: true

  # Enable BGP peering.
  # Docs: https://docs.cilium.io/en/latest/network/bgp-control-plane/bgp-control-plane/
  bgpControlPlane:
    enabled: true
