# talm: nodes=["172.16.0.35"], endpoints=["172.16.0.35"], templates=["templates/controlplane.yaml"]
# THIS FILE IS AUTOGENERATED. DO NOT EDIT IT!
machine:
  type: controlplane
  kubelet:
    nodeIP:
      validSubnets:
        - 172.16.0.0/24
  network:
    hostname: talos-3162c
    # -- Discovered interfaces:
    interfaces:
      - deviceSelector:
          busPath: fe2a0000.ethernet
        addresses:
          - 172.16.0.35/24
        routes:
          - network: 0.0.0.0/0
            gateway: 172.16.0.254
    nameservers:
      - 1.1.1.1
      - 1.0.0.1
  install:
    # -- Discovered disks:
    # /dev/nvme0n1:
    #    model: KINGSTON SNVS250G
    #    serial: 50026B7685B3134C
    #    wwid: eui.00000000000000000026b7685b3134c5
    #    size: 250 GB
    disk: /dev/mmcblk0
cluster:
  controlPlane:
    endpoint: https://172.16.0.35:6443
  clusterName: lab01
  network:
    cni:
      name: none
    podSubnets:
      - 172.31.0.0/16
    serviceSubnets:
      - 172.30.0.0/16
  etcd:
    advertisedSubnets:
      - 172.16.0.0/24
  inlineManifests:
    - name: cilium-install
      contents: |
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: cilium-install
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: cilium-install
          namespace: kube-system
        ---
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: cilium-install
          namespace: kube-system
        ---
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: cilium-install
          namespace: kube-system
        spec:
          backoffLimit: 10
          template:
            metadata:
              labels:
                app: cilium-install
            spec:
              restartPolicy: OnFailure
              tolerations:
                - operator: Exists
                - effect: NoSchedule
                  operator: Exists
                - effect: NoExecute
                  operator: Exists
                - effect: PreferNoSchedule
                  operator: Exists
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
                  effect: NoSchedule
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
                  effect: NoExecute
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
                  effect: PreferNoSchedule
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                          - key: node-role.kubernetes.io/control-plane
                            operator: Exists
              serviceAccount: cilium-install
              serviceAccountName: cilium-install
              hostNetwork: true
              containers:
                - name: cilium-install
                  image: alpine/helm:3.12.3
                  env:
                    - name: KUBERNETES_SERVICE_HOST
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: status.podIP
                    - name: KUBERNETES_SERVICE_PORT
                      value: "6443"
                  command:
                    - /bin/sh
                    - -c
                    - |
                      helm repo add cilium https://helm.cilium.io
                      helm repo update
                      helm upgrade --install cilium cilium/cilium \
                        --namespace kube-system \
                        --set ipam.mode=kubernetes \
                        --set kubeProxyReplacement=true \
                        --set securityContext.capabilities.ciliumAgent="{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}" \
                        --set securityContext.capabilities.cleanCiliumState="{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}" \
                        --set cgroup.autoMount.enabled=false \
                        --set cgroup.hostRoot=/sys/fs/cgroup \
                        --set k8sServiceHost=localhost \
                        --set k8sServicePort=7445 \
                        --set operator.replicas=1
  allowSchedulingOnControlPlanes: true


